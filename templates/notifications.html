{% extends "base.html" %}

{% block title %}Notifications Management - PepperAI Admin{% endblock %}

{% block breadcrumb %}
<span class="breadcrumb-separator">></span>
<span class="breadcrumb-item">Notifications</span>
{% endblock %}

{% block content %}
<div class="notifications-container">
    <!-- Header Section -->
    <div class="page-header">
        <div class="header-content">
            <h1><i class="fas fa-bell"></i> Notifications Management</h1>
            <p class="header-subtitle">Send messages and notifications to users</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="openNotificationModal()">
                <i class="fas fa-plus"></i> New Notification
            </button>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
        <div class="filters-grid">
            <div class="filter-group">
                <label>Status</label>
                <select id="statusFilter" onchange="loadNotifications()">
                    <option value="all">All Notifications</option>
                    <option value="active">Active</option>
                    <option value="draft">Drafts</option>
                    <option value="expired">Expired</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Search</label>
                <input type="text" id="searchFilter" placeholder="Search notifications..." onkeyup="debounceSearch()">
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid" id="notificationStats">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-bell"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number" id="totalNotifications">0</div>
                <div class="stat-label">Total Notifications</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-eye"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number" id="readNotifications">0</div>
                <div class="stat-label">Read Notifications</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number" id="totalUsers">0</div>
                <div class="stat-label">Total Users</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-paper-plane"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number" id="activeNotifications">0</div>
                <div class="stat-label">Active Notifications</div>
            </div>
        </div>
    </div>

    <!-- Notifications List -->
    <div class="notifications-list">
        <div class="list-header">
            <h3>All Notifications</h3>
            <div class="list-controls">
                <button class="btn btn-secondary" onclick="refreshNotifications()">
                    <i class="fas fa-refresh"></i> Refresh
                </button>
            </div>
        </div>
        
        <div class="notifications-table-container">
            <div id="notificationsLoading" class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <span>Loading notifications...</span>
            </div>
            
            <div id="notificationsError" class="error-message" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <span>Error loading notifications</span>
                <button onclick="loadNotifications()">Retry</button>
            </div>
            
            <div class="notifications-table" id="notificationsTable">
                <!-- Notifications will be loaded here -->
            </div>
        </div>
        
        <!-- Pagination -->
        <div class="pagination-container" id="paginationContainer">
            <!-- Pagination will be loaded here -->
        </div>
    </div>
</div>

<!-- Notification Modal -->
<div id="notificationModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-content notification-modal" role="document">
        <div class="modal-header">
            <h2 id="modalTitle">New Notification</h2>
            <button class="modal-close" onclick="closeNotificationModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="notificationForm" onsubmit="saveNotification(event)">
            <div class="modal-body">
                <div class="form-grid">
                    <!-- Left Column -->
                    <div class="form-column">
                        <div class="form-group">
                            <label for="notificationTitle">Title *</label>
                            <input type="text" id="notificationTitle" name="title" required maxlength="200" placeholder="Enter notification title" aria-describedby="titleHelp titleCount">
                            <div class="field-meta">
                                <small id="titleHelp" class="helper-text">Keep it concise and informative.</small>
                                <small id="titleCount" class="char-count">0/200</small>
                            </div>
                            <div id="titleError" class="error-text" aria-live="polite"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="notificationMessage">Message *</label>
                            <textarea id="notificationMessage" name="message" required rows="6" maxlength="2000" placeholder="Enter your message..." aria-describedby="messageHelp messageCount"></textarea>
                            <div class="field-meta">
                                <small id="messageHelp" class="helper-text">You can use line breaks to format.</small>
                                <small id="messageCount" class="char-count">0/2000</small>
                            </div>
                            <div id="messageError" class="error-text" aria-live="polite"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="notificationPriority">Priority</label>
                            <select id="notificationPriority" name="priority">
                                <option value="low">Low</option>
                                <option value="normal" selected>Normal</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="notificationCategory">Category</label>
                            <select id="notificationCategory" name="category">
                                <option value="general">General</option>
                                <option value="system">System</option>
                                <option value="update">Update</option>
                                <option value="alert">Alert</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Right Column -->
                    <div class="form-column">
                        <div class="form-group">
                            <label for="recipientType">Recipients</label>
                            <select id="recipientType" name="recipient_type" onchange="toggleRecipientSelection()">
                                <option value="all">All Users</option>
                                <option value="specific">Specific Users</option>
                            </select>
                            <small class="helper-text">Choose "Specific Users" to target selected accounts.</small>
                        </div>
                        
                        <div class="form-group" id="specificRecipientsGroup" style="display: none;">
                            <label>Select Users</label>
                            <div class="user-selection-container">
                                <input type="text" id="userSearch" placeholder="Search users..." onkeyup="filterUsers()">
                                <div class="user-selection-list" id="userSelectionList">
                                    <!-- Users will be loaded here -->
                                </div>
                            </div>
                            <div id="recipientsError" class="error-text" aria-live="polite"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="scheduledFor">Schedule For (Optional)</label>
                            <input type="datetime-local" id="scheduledFor" name="scheduled_for" aria-describedby="scheduleHelp">
                            <small id="scheduleHelp" class="helper-text">Leave empty to send immediately when activated.</small>
                            <div id="scheduledError" class="error-text" aria-live="polite"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="expiresAt">Expires At (Optional)</label>
                            <input type="datetime-local" id="expiresAt" name="expires_at" aria-describedby="expiresHelp">
                            <small id="expiresHelp" class="helper-text">After this time, users will no longer see it.</small>
                            <div id="expiresError" class="error-text" aria-live="polite"></div>
                        </div>
                        
                        <div class="form-group">
                            <label>File Attachments</label>
                            <div class="file-upload-container">
                                <input type="file" id="fileUpload" multiple style="display: none;" onchange="handleFileUpload(event)">
                                <button type="button" class="btn btn-secondary" onclick="document.getElementById('fileUpload').click()">
                                    <i class="fas fa-paperclip"></i> Add Files
                                </button>
                                <div class="file-list" id="fileList">
                                    <!-- Uploaded files will be shown here -->
                                </div>
                            </div>
                            <small class="helper-text">Max 16MB per file. Allowed: images, documents, archives.</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="checkbox-container">
                                <input type="checkbox" id="isDraft" name="is_draft">
                                <span class="checkmark"></span>
                                Save as Draft
                            </label>
                            <small class="helper-text">Drafts are not visible to users until activated.</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer sticky">
                <button type="button" class="btn btn-secondary" onclick="closeNotificationModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" id="saveNotificationBtn" aria-live="polite">
                    <i class="fas fa-save"></i> Save Notification
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Notification Details Modal -->
<div id="notificationDetailsModal" class="modal">
    <div class="modal-content notification-details-modal">
        <div class="modal-header">
            <h2>Notification Details</h2>
            <button class="modal-close" onclick="closeNotificationDetailsModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-body" id="notificationDetailsContent">
            <!-- Details will be loaded here -->
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeNotificationDetailsModal()">Close</button>
        </div>
    </div>
</div>

<style>
.notifications-container {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
    width: 100%;
    overflow-x: hidden;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid #e0e0e0;
}

.header-content h1 {
    color: #2c3e50;
    font-size: 2.2rem;
    margin: 0 0 10px 0;
    display: flex;
    align-items: center;
    gap: 15px;
}

.header-content h1 i {
    color: #3498db;
}

.header-subtitle {
    color: #7f8c8d;
    font-size: 1.1rem;
    margin: 0;
}

.filters-section {
    background: white;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.filter-group {
    display: flex;
    flex-direction: column;
}

.filter-group label {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 8px;
}

.filter-group select,
.filter-group input {
    padding: 12px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.3s ease;
}

.filter-group select:focus,
.filter-group input:focus {
    outline: none;
    border-color: #3498db;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 25px;
    display: flex;
    align-items: center;
    gap: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: transform 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
    background: linear-gradient(135deg, #3498db, #2980b9);
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 5px;
}

.stat-label {
    color: #7f8c8d;
    font-size: 14px;
}

.notifications-list {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
}

.list-header h3 {
    color: #2c3e50;
    margin: 0;
    font-size: 1.4rem;
}

.notifications-table-container {
    position: relative;
    min-height: 300px;
}

.loading-spinner {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px;
    color: #7f8c8d;
}

.loading-spinner i {
    font-size: 2rem;
    margin-bottom: 15px;
}

.error-message {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px;
    color: #e74c3c;
}

.notifications-table {
    width: 100%;
}

.notification-item {
    display: grid;
    grid-template-columns: 1fr auto auto auto;
    gap: 20px;
    padding: 20px;
    border-bottom: 1px solid #f0f0f0;
    align-items: center;
    transition: background-color 0.2s ease;
}

.notification-item:hover {
    background-color: #f8f9fa;
}

.notification-content h4 {
    margin: 0 0 8px 0;
    color: #2c3e50;
    font-size: 1.1rem;
    word-break: break-word;
}

.notification-meta {
    display: flex;
    gap: 15px;
    color: #7f8c8d;
    font-size: 13px;
    flex-wrap: wrap;
}

.notification-message {
    color: #555;
    margin-top: 8px;
    font-size: 14px;
    line-height: 1.4;
    word-break: break-word;
}

.priority-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.priority-low { background: #d4edda; color: #155724; }
.priority-normal { background: #d1ecf1; color: #0c5460; }
.priority-high { background: #fff3cd; color: #856404; }
.priority-urgent { background: #f8d7da; color: #721c24; }

.status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.status-active { background: #d4edda; color: #155724; }
.status-draft { background: #fff3cd; color: #856404; }
.status-expired { background: #f8d7da; color: #721c24; }

.notification-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.action-btn {
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 5px;
}

.action-btn.view { background: #3498db; color: white; }
.action-btn.edit { background: #f39c12; color: white; }
.action-btn.delete { background: #e74c3c; color: white; }

.action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    animation: fadeIn 0.3s ease;
}

/* Ensure modal panel is visibly distinct and centered */
.modal .modal-content {
    background: #ffffff;
    margin: 40px auto;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow: hidden;
    border-top: 4px solid #3498db;
}

.modal .modal-header,
.modal .modal-body,
.modal .modal-footer {
    background: #ffffff;
}

.modal .modal-header {
    padding: 16px 20px;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.modal .modal-header h2 {
    margin: 0;
    color: #2c3e50;
    font-size: 1.4rem;
}

.modal .modal-body {
    padding: 20px;
}

.modal .modal-footer {
    padding: 12px 20px;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.notification-modal {
    max-width: 900px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

.notification-details-modal {
    max-width: 800px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-footer.sticky {
    position: sticky;
    bottom: 0;
    background: #fff;
    padding-top: 12px;
    border-top: 1px solid #e0e0e0;
}

.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
}

.form-column {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 8px;
}

.form-group input,
.form-group textarea,
.form-group select {
    padding: 12px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.3s ease;
}

.field-meta {
    display: flex;
    justify-content: space-between;
    margin-top: 6px;
}

.helper-text {
    color: #7f8c8d;
}

.char-count {
    color: #95a5a6;
}

.error-text {
    color: #e74c3c;
    font-size: 12px;
    margin-top: 6px;
}

/* Notification details styling */
.notification-details {
    display: flex;
    flex-direction: column;
    gap: 18px;
}

.notification-details .details-header {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.notification-details .details-header h3 {
    margin: 0;
    color: #2c3e50;
    font-size: 1.3rem;
}

.notification-details .details-meta {
    display: flex;
    gap: 10px;
    align-items: center;
}

.notification-details .detail-section {
    background: #ffffff;
    border: 1px solid #eef2f4;
    border-radius: 10px;
    padding: 14px 16px;
}

.notification-details .detail-section h4 {
    margin: 0 0 10px 0;
    color: #2c3e50;
    font-size: 1rem;
}

.notification-details .detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 10px 16px;
}

.notification-details .stats-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
}

.notification-details .stat-item {
    background: #f8fafb;
    border: 1px solid #e8eef2;
    border-radius: 10px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
}

.notification-details .stat-number {
    font-size: 1.6rem;
    font-weight: 700;
    color: #2c3e50;
}

.notification-details .stat-label {
    color: #7f8c8d;
    font-size: 0.85rem;
}

.notification-details .attachments-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 10px;
}

.notification-details .attachment-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border: 1px solid #e8eef2;
    border-radius: 8px;
    background: #f9fbfc;
}

.notification-details .attachment-link,
.file-item .file-link {
    color: #3498db;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: color 0.2s;
}

.notification-details .attachment-link:hover,
.file-item .file-link:hover {
    color: #2980b9;
    text-decoration: underline;
}

.notification-details .attachment-link span,
.file-item .file-link span {
    cursor: pointer;
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
    outline: none;
    border-color: #3498db;
}

.user-selection-container {
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    max-height: 200px;
    overflow-y: auto;
}

.user-selection-list {
    padding: 10px;
}

.user-option {
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: background-color 0.2s ease;
}

.user-option:hover {
    background-color: #f8f9fa;
}

.user-option.selected {
    background-color: #3498db;
    color: white;
}

.file-upload-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.file-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.file-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    background: #f8f9fa;
    border-radius: 6px;
    border: 1px solid #e0e0e0;
}

.file-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.file-size {
    color: #7f8c8d;
    font-size: 12px;
}

.checkbox-container {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
}

.checkbox-container input {
    width: auto;
    margin: 0;
}

.pagination-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
}

.pagination-btn {
    padding: 8px 12px;
    border: 1px solid #e0e0e0;
    background: white;
    color: #2c3e50;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.pagination-btn:hover:not(:disabled) {
    background: #3498db;
    color: white;
}

.pagination-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.pagination-btn.active {
    background: #3498db;
    color: white;
    border-color: #3498db;
}

/* Tablet */
@media (max-width: 1024px) {
    .notification-item {
        grid-template-columns: 1fr auto auto;
        gap: 12px;
    }
}

@media (max-width: 768px) {
    .page-header {
        flex-direction: column;
        gap: 20px;
        align-items: stretch;
    }
    
    .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }
    
    .notification-item { grid-template-columns: 1fr; gap: 12px; }
    
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    .notification-modal,
    .notification-details-modal {
        width: 95%;
    }
}

/* Mobile */
@media (max-width: 480px) {
    .notifications-container { padding: 12px; width: 100%; overflow-x: hidden; }
    .header-content h1 { font-size: 1.5rem; }
    .stat-number { font-size: 1.4rem; }
    .priority-badge, .status-badge { font-size: 11px; }
    .action-btn { padding: 6px 10px; font-size: 11px; }
    .page-header, .filters-section, .stats-grid, .notifications-list, .notifications-table-container { max-width: 100%; overflow-x: hidden; }
    .notifications-table { width: 100%; overflow-x: hidden; }
}

/* Prevent horizontal overflow from any child */
.notifications-container *,
.notifications-container *::before,
.notifications-container *::after {
    box-sizing: border-box;
}
</style>

<script>
let currentPage = 1;
let currentNotificationId = null;
let selectedUsers = [];
let uploadedFiles = [];
let allUsers = [];

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadNotifications();
    loadUsers();
    loadStats();
    // counters
    const titleEl = document.getElementById('notificationTitle');
    const msgEl = document.getElementById('notificationMessage');
    if (titleEl) {
        titleEl.addEventListener('input', updateTitleCount);
        updateTitleCount();
    }
    if (msgEl) {
        msgEl.addEventListener('input', updateMessageCount);
        updateMessageCount();
    }
});

// Load notifications
async function loadNotifications(page = 1) {
    const status = document.getElementById('statusFilter').value;
    const search = document.getElementById('searchFilter').value;
    
    showLoading(true);
    hideError();
    
    try {
        const params = new URLSearchParams({
            page: page,
            per_page: 10,
            status: status
        });
        
        if (search) {
            params.append('search', search);
        }
        
        const response = await fetch(`/api/notifications?${params}`);
        const data = await response.json();
        
        if (response.ok) {
            displayNotifications(data.notifications);
            displayPagination(data.pagination);
            currentPage = page;
        } else {
            showError(data.error || 'Failed to load notifications');
        }
    } catch (error) {
        showError('Network error: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// Display notifications
function displayNotifications(notifications) {
    const container = document.getElementById('notificationsTable');
    
    if (notifications.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-bell-slash"></i>
                <h3>No notifications found</h3>
                <p>Create your first notification to get started.</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = notifications.map(notification => `
        <div class="notification-item">
            <div class="notification-content">
                <h4>${escapeHtml(notification.title)}</h4>
                <div class="notification-meta">
                    <span><i class="fas fa-user"></i> ${escapeHtml(notification.sender)}</span>
                    <span><i class="fas fa-calendar"></i> ${formatDate(notification.created_at)}</span>
                    <span><i class="fas fa-users"></i> ${notification.recipient_type === 'all' ? 'All Users' : notification.total_recipients + ' users'}</span>
                    ${notification.read_count > 0 ? `<span><i class="fas fa-eye"></i> ${notification.read_count}/${notification.total_recipients} read</span>` : ''}
                </div>
                <div class="notification-message">
                    ${escapeHtml(notification.message.substring(0, 150))}${notification.message.length > 150 ? '...' : ''}
                </div>
            </div>
            
            <div class="priority-badge priority-${notification.priority}">
                ${notification.priority}
            </div>
            
            <div class="status-badge status-${notification.is_draft ? 'draft' : notification.is_active ? 'active' : 'expired'}">
                ${notification.is_draft ? 'Draft' : notification.is_active ? 'Active' : 'Expired'}
            </div>
            
            <div class="notification-actions">
                <button class="action-btn view" onclick="viewNotification(${notification.id})" title="View Details">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="action-btn edit" onclick="editNotification(${notification.id})" title="Edit">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn delete" onclick="deleteNotification(${notification.id})" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `).join('');
}

// Display pagination
function displayPagination(pagination) {
    const container = document.getElementById('paginationContainer');
    
    if (pagination.pages <= 1) {
        container.innerHTML = '';
        return;
    }
    
    let paginationHTML = '';
    
    // Previous button
    paginationHTML += `
        <button class="pagination-btn" ${!pagination.has_prev ? 'disabled' : ''} 
                onclick="loadNotifications(${pagination.page - 1})">
            <i class="fas fa-chevron-left"></i> Previous
        </button>
    `;
    
    // Page numbers
    const startPage = Math.max(1, pagination.page - 2);
    const endPage = Math.min(pagination.pages, pagination.page + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
            <button class="pagination-btn ${i === pagination.page ? 'active' : ''}" 
                    onclick="loadNotifications(${i})">
                ${i}
            </button>
        `;
    }
    
    // Next button
    paginationHTML += `
        <button class="pagination-btn" ${!pagination.has_next ? 'disabled' : ''} 
                onclick="loadNotifications(${pagination.page + 1})">
            Next <i class="fas fa-chevron-right"></i>
        </button>
    `;
    
    container.innerHTML = paginationHTML;
}

// Load statistics
async function loadStats() {
    try {
        const response = await fetch('/api/notifications?page=1&per_page=1000');
        const data = await response.json();
        
        if (response.ok) {
            const notifications = data.notifications;
            const totalNotifications = notifications.length;
            const activeNotifications = notifications.filter(n => n.is_active && !n.is_draft).length;
            const totalReadCount = notifications.reduce((sum, n) => sum + n.read_count, 0);
            
            document.getElementById('totalNotifications').textContent = totalNotifications;
            document.getElementById('activeNotifications').textContent = activeNotifications;
            document.getElementById('readNotifications').textContent = totalReadCount;
        }
    } catch (error) {
        console.error('Error loading stats:', error);
    }
    
    // Load user count
    try {
        const response = await fetch('/api/notifications/users');
        const users = await response.json();
        document.getElementById('totalUsers').textContent = users.length;
    } catch (error) {
        console.error('Error loading user count:', error);
    }
}

// Load users for recipient selection
async function loadUsers() {
    try {
        const response = await fetch('/api/notifications/users');
        allUsers = await response.json();
        displayUsers();
    } catch (error) {
        console.error('Error loading users:', error);
    }
}

// Display users in selection list
function displayUsers() {
    const container = document.getElementById('userSelectionList');
    const searchTerm = document.getElementById('userSearch').value.toLowerCase();
    
    const filteredUsers = allUsers.filter(user => 
        user.username.toLowerCase().includes(searchTerm) ||
        (user.full_name && user.full_name.toLowerCase().includes(searchTerm)) ||
        user.email.toLowerCase().includes(searchTerm)
    );
    
    container.innerHTML = filteredUsers.map(user => `
        <div class="user-option ${selectedUsers.includes(user.id) ? 'selected' : ''}" 
             onclick="toggleUser(${user.id})">
            <input type="checkbox" ${selectedUsers.includes(user.id) ? 'checked' : ''} 
                   onchange="toggleUser(${user.id})">
            <div>
                <div><strong>${escapeHtml(user.full_name || user.username)}</strong></div>
                <div class="user-email">${escapeHtml(user.email)}</div>
            </div>
        </div>
    `).join('');
}

// Toggle user selection
function toggleUser(userId) {
    const index = selectedUsers.indexOf(userId);
    if (index > -1) {
        selectedUsers.splice(index, 1);
    } else {
        selectedUsers.push(userId);
    }
    displayUsers();
}

// Filter users
function filterUsers() {
    displayUsers();
}

// Toggle recipient selection
function toggleRecipientSelection() {
    const recipientType = document.getElementById('recipientType').value;
    const specificGroup = document.getElementById('specificRecipientsGroup');
    
    if (recipientType === 'specific') {
        specificGroup.style.display = 'block';
        displayUsers();
    } else {
        specificGroup.style.display = 'none';
        selectedUsers = [];
    }
}

// Handle file upload
async function handleFileUpload(event) {
    const files = event.target.files;
    
    for (let file of files) {
        if (file.size > 16 * 1024 * 1024) { // 16MB limit
            alert(`File "${file.name}" is too large. Maximum size is 16MB.`);
            continue;
        }
        
        const formData = new FormData();
        formData.append('file', file);
        
        try {
            const response = await fetch('/api/notifications/upload', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (response.ok) {
                uploadedFiles.push(result.attachment);
                displayUploadedFiles();
            } else {
                alert(`Error uploading "${file.name}": ${result.error}`);
            }
        } catch (error) {
            alert(`Error uploading "${file.name}": ${error.message}`);
        }
    }
    
    // Clear the input
    event.target.value = '';
}

// Display uploaded files
function displayUploadedFiles() {
    const container = document.getElementById('fileList');
    
    container.innerHTML = uploadedFiles.map((file, index) => `
        <div class="file-item">
            <div class="file-info">
                <i class="fas fa-${getFileIcon(file.file_type)}"></i>
                ${file.id ? `
                    <a href="/notifications/attachment/${file.id}" target="_blank" class="file-link">
                <span>${escapeHtml(file.original_filename)}</span>
                <span class="file-size">(${formatFileSize(file.file_size)})</span>
                    </a>
                ` : `
                    <span>${escapeHtml(file.original_filename)}</span>
                    <span class="file-size">(${formatFileSize(file.file_size)})</span>
                `}
            </div>
            <button type="button" onclick="removeUploadedFile(${index})" class="btn btn-sm btn-danger">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `).join('');
}

// Remove uploaded file
function removeUploadedFile(index) {
    uploadedFiles.splice(index, 1);
    displayUploadedFiles();
}

// Get file icon
function getFileIcon(fileType) {
    switch (fileType) {
        case 'image': return 'image';
        case 'document': return 'file-alt';
        default: return 'file';
    }
}

// Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Open notification modal
function openNotificationModal(notificationId = null) {
    currentNotificationId = notificationId;
    const modal = document.getElementById('notificationModal');
    const form = document.getElementById('notificationForm');
    
    if (notificationId) {
        // Edit mode - load notification data
        document.getElementById('modalTitle').textContent = 'Edit Notification';
        loadNotificationForEdit(notificationId);
    } else {
        // New notification mode
        document.getElementById('modalTitle').textContent = 'New Notification';
        form.reset();
        selectedUsers = [];
        uploadedFiles = [];
        displayUploadedFiles();
        toggleRecipientSelection();
    }
    
    modal.style.display = 'block';
    // prevent background scroll
    document.body.style.overflow = 'hidden';
    // focus first field
    setTimeout(() => document.getElementById('notificationTitle').focus(), 0);
}

// Close notification modal
function closeNotificationModal() {
    const modal = document.getElementById('notificationModal');
    modal.style.display = 'none';
    currentNotificationId = null;
    clearFormErrors();
    // restore background scroll
    document.body.style.overflow = '';
}

// Load notification for editing
async function loadNotificationForEdit(notificationId) {
    try {
        const response = await fetch(`/api/notifications/${notificationId}`);
        const notification = await response.json();
        
        if (response.ok) {
            // Populate form fields
            document.getElementById('notificationTitle').value = notification.title;
            document.getElementById('notificationMessage').value = notification.message;
            document.getElementById('notificationPriority').value = notification.priority;
            document.getElementById('notificationCategory').value = notification.category;
            document.getElementById('recipientType').value = notification.recipient_type;
            document.getElementById('isDraft').checked = notification.is_draft;
            
            if (notification.scheduled_for) {
                document.getElementById('scheduledFor').value = new Date(notification.scheduled_for).toISOString().slice(0, 16);
            }
            
            if (notification.expires_at) {
                document.getElementById('expiresAt').value = new Date(notification.expires_at).toISOString().slice(0, 16);
            }
            
            // Set recipients
            if (notification.recipient_type === 'specific' && notification.recipient_ids) {
                selectedUsers = JSON.parse(notification.recipient_ids);
            } else {
                selectedUsers = [];
            }
            
            toggleRecipientSelection();
            
            // Set attachments
            uploadedFiles = notification.attachments || [];
            displayUploadedFiles();
        }
    } catch (error) {
        alert('Error loading notification: ' + error.message);
    }
}

// Save notification
async function saveNotification(event) {
    event.preventDefault();
    
    // Disable button during submit
    const saveBtn = document.getElementById('saveNotificationBtn');
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

    clearFormErrors();
    const valid = validateNotificationForm();
    if (!valid) {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Notification';
        return;
    }

    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData.entries());
    
    // Add additional data
    if (selectedUsers.length > 0) {
        data.recipient_ids = selectedUsers;
    }
    
    if (uploadedFiles.length > 0) {
        data.attachment_ids = uploadedFiles.map(f => f.id);
    }
    
    data.is_draft = document.getElementById('isDraft').checked;
    
    try {
        const url = currentNotificationId 
            ? `/api/notifications/${currentNotificationId}`
            : '/api/notifications';
            
        const method = currentNotificationId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert(result.message);
            closeNotificationModal();
            loadNotifications(currentPage);
            loadStats();
        } else {
            // Inline error if possible
            if (result && result.error) {
                showFormError('titleError', result.error);
            } else {
                alert('Error: ' + (result && result.error ? result.error : 'Unknown error'));
            }
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    }
    finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Notification';
    }
}

// View notification details
async function viewNotification(notificationId) {
    try {
        const response = await fetch(`/api/notifications/${notificationId}/stats`);
        const data = await response.json();
        
        if (response.ok) {
            displayNotificationDetails(data);
        } else {
            alert('Error loading notification details: ' + data.error);
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    }
}

// Display notification details
function displayNotificationDetails(data) {
    const notification = data.notification;
    const stats = data.stats;
    
    const content = document.getElementById('notificationDetailsContent');
    content.innerHTML = `
        <div class="notification-details">
            <div class="details-header">
                <h3>${escapeHtml(notification.title)}</h3>
                <div class="details-meta">
                    <span class="priority-badge priority-${notification.priority}">${notification.priority}</span>
                    <span class="status-badge status-${notification.is_draft ? 'draft' : notification.is_active ? 'active' : 'expired'}">
                        ${notification.is_draft ? 'Draft' : notification.is_active ? 'Active' : 'Expired'}
                    </span>
                </div>
            </div>
            
            <div class="details-content">
                <div class="detail-section">
                    <h4>Message</h4>
                    <p>${escapeHtml(notification.message).replace(/\n/g, '<br>')}</p>
                </div>
                
                <div class="detail-section">
                    <h4>Information</h4>
                    <div class="detail-grid">
                        <div><strong>Sender:</strong> ${escapeHtml(notification.sender)}</div>
                        <div><strong>Category:</strong> ${escapeHtml(notification.category)}</div>
                        <div><strong>Created:</strong> ${formatDate(notification.created_at)}</div>
                        <div><strong>Recipients:</strong> ${notification.recipient_type === 'all' ? 'All Users' : stats.total_recipients + ' specific users'}</div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4>Read Statistics</h4>
                    <div class="stats-summary">
                        <div class="stat-item">
                            <span class="stat-number">${stats.read_count}</span>
                            <span class="stat-label">Read</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${stats.unread_count}</span>
                            <span class="stat-label">Unread</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${stats.read_percentage.toFixed(1)}%</span>
                            <span class="stat-label">Read Rate</span>
                        </div>
                    </div>
                </div>
                
                ${notification.attachments && notification.attachments.length > 0 ? `
                <div class="detail-section">
                    <h4>Attachments</h4>
                    <div class="attachments-list">
                        ${notification.attachments.map(att => `
                            <div class="attachment-item">
                                <i class="fas fa-${getFileIcon(att.file_type)}"></i>
                                <a href="/notifications/attachment/${att.id}" target="_blank" class="attachment-link">
                                <span>${escapeHtml(att.original_filename)}</span>
                                <span class="file-size">(${formatFileSize(att.file_size)})</span>
                                </a>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
            </div>
        </div>
    `;
    
    const modal = document.getElementById('notificationDetailsModal');
    modal.style.display = 'block';
}

// Close notification details modal
function closeNotificationDetailsModal() {
    const modal = document.getElementById('notificationDetailsModal');
    modal.style.display = 'none';
}

// Edit notification
function editNotification(notificationId) {
    openNotificationModal(notificationId);
}

// Delete notification
async function deleteNotification(notificationId) {
    if (!confirm('Are you sure you want to delete this notification? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/notifications/${notificationId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert(result.message);
            loadNotifications(currentPage);
            loadStats();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    }
}

// Refresh notifications
function refreshNotifications() {
    loadNotifications(currentPage);
    loadStats();
}

// Debounced search
let notificationSearchTimeout;
function debounceSearch() {
    clearTimeout(notificationSearchTimeout);
    notificationSearchTimeout = setTimeout(() => {
        loadNotifications(1);
    }, 500);
}

// Utility functions
function showLoading(show) {
    const loading = document.getElementById('notificationsLoading');
    const table = document.getElementById('notificationsTable');
    
    if (show) {
        loading.style.display = 'flex';
        table.style.display = 'none';
    } else {
        loading.style.display = 'none';
        table.style.display = 'block';
    }
}

function showError(message) {
    const error = document.getElementById('notificationsError');
    error.querySelector('span').textContent = message;
    error.style.display = 'flex';
}

function hideError() {
    const error = document.getElementById('notificationsError');
    error.style.display = 'none';
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

// Close modal when clicking outside
window.onclick = function(event) {
    const notificationModal = document.getElementById('notificationModal');
    const detailsModal = document.getElementById('notificationDetailsModal');
    
    if (event.target === notificationModal) {
        closeNotificationModal();
    }
    
    if (event.target === detailsModal) {
        closeNotificationDetailsModal();
    }
}

// Close modal on Esc key
window.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const notificationModal = document.getElementById('notificationModal');
        const detailsModal = document.getElementById('notificationDetailsModal');
        if (notificationModal && notificationModal.style.display === 'block') {
            closeNotificationModal();
        }
        if (detailsModal && detailsModal.style.display === 'block') {
            closeNotificationDetailsModal();
        }
    }
});

// Form helpers
function updateTitleCount() {
    const el = document.getElementById('notificationTitle');
    const count = document.getElementById('titleCount');
    if (el && count) count.textContent = `${el.value.length}/${el.maxLength}`;
}

function updateMessageCount() {
    const el = document.getElementById('notificationMessage');
    const count = document.getElementById('messageCount');
    if (el && count) count.textContent = `${el.value.length}/${el.maxLength}`;
}

function showFormError(id, message) {
    const el = document.getElementById(id);
    if (el) el.textContent = message;
}

function clearFormErrors() {
    ['titleError','messageError','recipientsError','scheduledError','expiresError'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = '';
    });
}

function validateNotificationForm() {
    let ok = true;
    const title = document.getElementById('notificationTitle').value.trim();
    const message = document.getElementById('notificationMessage').value.trim();
    if (!title) { showFormError('titleError', 'Title is required'); ok = false; }
    if (!message) { showFormError('messageError', 'Message is required'); ok = false; }

    const recipientType = document.getElementById('recipientType').value;
    if (recipientType === 'specific' && selectedUsers.length === 0) {
        showFormError('recipientsError', 'Please select at least one user');
        ok = false;
    }

    const scheduledStr = document.getElementById('scheduledFor').value;
    const expiresStr = document.getElementById('expiresAt').value;
    const now = new Date();
    if (scheduledStr) {
        const sched = new Date(scheduledStr);
        if (sched < now) { showFormError('scheduledError', 'Schedule must be in the future'); ok = false; }
    }
    if (expiresStr) {
        const exp = new Date(expiresStr);
        if (exp < now) { showFormError('expiresError', 'Expiry must be in the future'); ok = false; }
        if (scheduledStr) {
            const sched = new Date(scheduledStr);
            if (exp <= sched) { showFormError('expiresError', 'Expiry must be after schedule time'); ok = false; }
        }
    }
    return ok;
}
</script>
{% endblock %}
