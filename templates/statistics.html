{% extends "base.html" %}

{% block title %}Statistics - PepperAI{% endblock %}
{% block description %}Comprehensive statistics and insights from your bell pepper analyses{% endblock %}

{% block extra_styles %}
<style>
    /* Mobile-first responsive styles for statistics.html */
    html { font-size: 14px; }

    /* Responsive media */
    img, canvas, video, svg { max-width: 100%; height: auto; }

    /* Grids */
    .statistics-stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; }
    .statistics-charts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; }
    .statistics-two-col-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; }

    /* Tablet */
    @media (min-width: 768px) and (max-width: 1024px) {
        html { font-size: 15px; }
        .statistics-stats-grid { grid-template-columns: repeat(3, 1fr); }
        .statistics-charts-grid { grid-template-columns: 1fr; }
        .statistics-two-col-grid { grid-template-columns: 1fr; }
    }

    /* Desktop */
    @media (min-width: 1024px) {
        html { font-size: 16px; }
        .statistics-stats-grid { grid-template-columns: repeat(4, 1fr); }
        .statistics-charts-grid { grid-template-columns: repeat(2, 1fr); }
        .statistics-two-col-grid { grid-template-columns: repeat(2, 1fr); }
    }

    /* Small phones */
    @media (max-width: 480px) {
        .statistics-stats-grid { grid-template-columns: 1fr; gap: 1rem; }
        .statistics-charts-grid { grid-template-columns: 1fr; gap: 1rem; }
        .statistics-two-col-grid { grid-template-columns: 1fr; gap: 1rem; }
    }
</style>
{% endblock %}

{% block breadcrumb_home %}Dashboard{% endblock %}
{% block breadcrumb %}
    <span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span>
    <span class="breadcrumb-item">Statistics</span>
{% endblock %}

{% block content %}
<div style="max-width: 100%; margin: 0 auto;">
    <!-- Page Header -->
    <div style="margin-bottom: 2rem;">
        <h1 style="font-size: 2rem; font-weight: 700; color: var(--dark); margin-bottom: 0.5rem;">
            <i class="fas fa-chart-line"></i> Analysis Statistics
        </h1>
        <p style="color: var(--secondary); font-size: 1rem;">
            Comprehensive insights and trends from your bell pepper analyses
        </p>
    </div>

    <!-- Main Statistics Cards -->
    <div class="statistics-stats-grid" style="margin-bottom: 3rem;">
        <!-- Total Peppers -->
        <div class="stat-card" style="background: var(--card-bg); backdrop-filter: blur(20px); border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 1.5rem; border: 1px solid rgba(255, 255, 255, 0.2); position: relative; overflow: hidden;">
            <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--primary), var(--primary-hover));"></div>
            <div class="stat-icon" style="width: 50px; height: 50px; background: var(--primary-light); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 1.5rem; margin-bottom: 1rem;">
                <i class="fas fa-pepper-hot"></i>
            </div>
            <div class="stat-value" style="font-size: 2rem; font-weight: 700; color: var(--dark); margin-bottom: 0.25rem;">{{ total_peppers }}</div>
            <div class="stat-label" style="color: var(--secondary); font-size: 0.9rem;">Total Peppers Analyzed</div>
        </div>
        
        <!-- Total Analyses -->
        <div class="stat-card" style="background: var(--card-bg); backdrop-filter: blur(20px); border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 1.5rem; border: 1px solid rgba(255, 255, 255, 0.2); position: relative; overflow: hidden;">
            <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--primary), var(--primary-hover));"></div>
            <div class="stat-icon" style="width: 50px; height: 50px; background: var(--primary-light); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 1.5rem; margin-bottom: 1rem;">
                <i class="fas fa-images"></i>
            </div>
            <div class="stat-value" style="font-size: 2rem; font-weight: 700; color: var(--dark); margin-bottom: 0.25rem;">{{ total_analyses }}</div>
            <div class="stat-label" style="color: var(--secondary); font-size: 0.9rem;">Total Analyses</div>
        </div>
        
        <!-- Average Quality -->
        <div class="stat-card" style="background: var(--card-bg); backdrop-filter: blur(20px); border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 1.5rem; border: 1px solid rgba(255, 255, 255, 0.2); position: relative; overflow: hidden;">
            <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #10b981, #059669);"></div>
            <div class="stat-icon" style="width: 50px; height: 50px; background: var(--success-light); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--success); font-size: 1.5rem; margin-bottom: 1rem;">
                <i class="fas fa-star"></i>
            </div>
            <div class="stat-value" style="font-size: 2rem; font-weight: 700; color: var(--dark); margin-bottom: 0.25rem;">{{ avg_quality }}%</div>
            <div class="stat-label" style="color: var(--secondary); font-size: 0.9rem;">Average Quality Score</div>
        </div>
        
        <!-- Average Confidence -->
        <div class="stat-card" style="background: var(--card-bg); backdrop-filter: blur(20px); border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 1.5rem; border: 1px solid rgba(255, 255, 255, 0.2); position: relative; overflow: hidden;">
            <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #f59e0b, #f97316);"></div>
            <div class="stat-icon" style="width: 50px; height: 50px; background: rgba(245, 158, 11, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #f59e0b; font-size: 1.5rem; margin-bottom: 1rem;">
                <i class="fas fa-crosshairs"></i>
            </div>
            <div class="stat-value" style="font-size: 2rem; font-weight: 700; color: var(--dark); margin-bottom: 0.25rem;">{{ (avg_confidence * 100)|round|int }}%</div>
            <div class="stat-label" style="color: var(--secondary); font-size: 0.9rem;">Average Confidence</div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="statistics-charts-grid" style="margin-bottom: 3rem;">
        <!-- Quality Distribution Chart -->
        <div style="background: var(--card-bg); backdrop-filter: blur(20px); border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 2rem; border: 1px solid rgba(255, 255, 255, 0.2);">
            <h3 style="font-size: 1.2rem; font-weight: 600; color: var(--dark); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-chart-pie" style="color: var(--primary);"></i>
                Quality Distribution
            </h3>
            <canvas id="qualityChart" style="max-height: 300px;"></canvas>
        </div>
        
        <!-- Variety Distribution Chart -->
        <div style="background: var(--card-bg); backdrop-filter: blur(20px); border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 2rem; border: 1px solid rgba(255, 255, 255, 0.2);">
            <h3 style="font-size: 1.2rem; font-weight: 600; color: var(--dark); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-chart-bar" style="color: var(--primary);"></i>
                Pepper Varieties
            </h3>
            <p style="color: var(--secondary); font-size: 0.75rem; margin-bottom: 1rem;">Top 10 most analyzed varieties</p>
            <canvas id="varietyChart" style="max-height: 300px;"></canvas>
        </div>
    </div>

    <!-- Temporal Analysis Chart -->
    <div style="background: var(--card-bg); backdrop-filter: blur(20px); border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 2rem; border: 1px solid rgba(255, 255, 255, 0.2); margin-bottom: 3rem;">
        <h3 style="font-size: 1.2rem; font-weight: 600; color: var(--dark); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-chart-area" style="color: var(--primary);"></i>
            Analysis Activity (Last 30 Days)
        </h3>
        <canvas id="temporalChart" style="max-height: 250px;"></canvas>
    </div>

    <!-- Quality Metrics -->
    <div style="background: var(--card-bg); backdrop-filter: blur(20px); border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 2rem; border: 1px solid rgba(255, 255, 255, 0.2); margin-bottom: 3rem;">
        <h3 style="font-size: 1.2rem; font-weight: 600; color: var(--dark); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-sliders-h" style="color: var(--primary);"></i>
            Average Quality Metrics
        </h3>
        <div class="statistics-stats-grid">
            <!-- Color Uniformity -->
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span style="font-size: 0.9rem; font-weight: 600; color: var(--dark);">Color Uniformity</span>
                    <span style="font-size: 0.9rem; font-weight: 700; color: var(--primary);">{{ quality_metrics.color_uniformity }}%</span>
                </div>
                <div style="width: 100%; height: 8px; background: rgba(79, 70, 229, 0.1); border-radius: 4px; overflow: hidden;">
                    <div style="height: 100%; background: linear-gradient(90deg, var(--primary), var(--primary-hover)); width: {{ quality_metrics.color_uniformity }}%; transition: width 0.5s ease;"></div>
                </div>
            </div>
            
            <!-- Size Consistency -->
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span style="font-size: 0.9rem; font-weight: 600; color: var(--dark);">Size Consistency</span>
                    <span style="font-size: 0.9rem; font-weight: 700; color: #10b981;">{{ quality_metrics.size_consistency }}%</span>
                </div>
                <div style="width: 100%; height: 8px; background: rgba(16, 185, 129, 0.1); border-radius: 4px; overflow: hidden;">
                    <div style="height: 100%; background: linear-gradient(90deg, #10b981, #059669); width: {{ quality_metrics.size_consistency }}%; transition: width 0.5s ease;"></div>
                </div>
            </div>
            
            <!-- Surface Quality -->
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span style="font-size: 0.9rem; font-weight: 600; color: var(--dark);">Surface Quality</span>
                    <span style="font-size: 0.9rem; font-weight: 700; color: #f59e0b;">{{ quality_metrics.surface_quality }}%</span>
                </div>
                <div style="width: 100%; height: 8px; background: rgba(245, 158, 11, 0.1); border-radius: 4px; overflow: hidden;">
                    <div style="height: 100%; background: linear-gradient(90deg, #f59e0b, #f97316); width: {{ quality_metrics.surface_quality }}%; transition: width 0.5s ease;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Health Statistics -->
    {% if health_stats.healthy + health_stats.diseased > 0 %}
    <div style="background: var(--card-bg); backdrop-filter: blur(20px); border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 2rem; border: 1px solid rgba(255, 255, 255, 0.2); margin-bottom: 3rem;">
        <h3 style="font-size: 1.2rem; font-weight: 600; color: var(--dark); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-heartbeat" style="color: var(--primary);"></i>
            Health Status Distribution
        </h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
            <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(16, 185, 129, 0.08), rgba(16, 185, 129, 0.15)); border-radius: var(--border-radius); border: 2px solid rgba(16, 185, 129, 0.3);">
                <div style="font-size: 2rem; font-weight: 700; color: #10b981; margin-bottom: 0.5rem;">{{ health_stats.healthy }}</div>
                <div style="color: #059669; font-weight: 600; font-size: 0.9rem;">
                    <i class="fas fa-check-circle"></i> Healthy Peppers
                </div>
            </div>
            <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(239, 68, 68, 0.08), rgba(239, 68, 68, 0.15)); border-radius: var(--border-radius); border: 2px solid rgba(239, 68, 68, 0.3);">
                <div style="font-size: 2rem; font-weight: 700; color: #ef4444; margin-bottom: 0.5rem;">{{ health_stats.diseased }}</div>
                <div style="color: #dc2626; font-weight: 600; font-size: 0.9rem;">
                    <i class="fas fa-exclamation-triangle"></i> Diseased Peppers
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Two Column Layout: Top Peppers and Recent Activity -->
    <div class="statistics-two-col-grid" style="margin-bottom: 3rem;">
        <!-- Top Quality Peppers -->
        <div style="background: var(--card-bg); backdrop-filter: blur(20px); border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 2rem; border: 1px solid rgba(255, 255, 255, 0.2);">
            <h3 style="font-size: 1.2rem; font-weight: 600; color: var(--dark); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-trophy" style="color: #f59e0b;"></i>
                Top Quality Peppers
            </h3>
            <p style="color: var(--secondary); font-size: 0.75rem; margin-bottom: 1rem;">Top 5 highest scoring peppers</p>
            {% if top_peppers %}
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                {% for pepper in top_peppers %}
                <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: linear-gradient(145deg, #ffffff 0%, #f8fffe 100%); border-radius: var(--border-radius-sm); border: 1px solid rgba(0, 0, 0, 0.05);">
                    {% if pepper.crop_path %}
                    <img src="/results/{{ pepper.crop_path }}?t={{ pepper.created_at.timestamp() }}" 
                         alt="{{ pepper.variety }}" 
                         onclick="showImagePreview(this.src, '{{ pepper.variety }}', '{{ pepper.quality_score|round|int }}%')"
                         onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'"
                         style="width: 50px; height: 50px; border-radius: 8px; object-fit: cover; border: 2px solid #ffffff; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15); cursor: pointer; transition: transform 0.2s;">
                    {% else %}
                    <div style="width: 50px; height: 50px; border-radius: 8px; background: var(--primary-light); display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 1.2rem;">
                        <i class="fas fa-pepper-hot"></i>
                    </div>
                    {% endif %}
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 600; color: var(--dark); font-size: 0.9rem; margin-bottom: 0.25rem;">{{ pepper.variety }}</div>
                        <div style="font-size: 0.75rem; color: var(--secondary);">{{ pepper.created_at.strftime('%b %d, %Y') }}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 1.2rem; font-weight: 700; color: {% if pepper.quality_score >= 80 %}#10b981{% elif pepper.quality_score >= 60 %}#3b82f6{% elif pepper.quality_score >= 40 %}#f59e0b{% else %}#ef4444{% endif %};">
                            {{ pepper.quality_score|round|int }}%
                        </div>
                        <div style="font-size: 0.7rem; color: var(--secondary);">Quality</div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p style="text-align: center; color: var(--secondary); padding: 2rem;">No peppers analyzed yet.</p>
            {% endif %}
        </div>

        <!-- Recent Activity -->
        <div style="background: var(--card-bg); backdrop-filter: blur(20px); border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 2rem; border: 1px solid rgba(255, 255, 255, 0.2);">
            <h3 style="font-size: 1.2rem; font-weight: 600; color: var(--dark); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-clock" style="color: var(--primary);"></i>
                Recent Activity
            </h3>
            <p style="color: var(--secondary); font-size: 0.75rem; margin-bottom: 1rem;">Last 10 analyzed peppers</p>
            {% if recent_activity %}
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                {% for pepper in recent_activity %}
                <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: linear-gradient(145deg, #ffffff 0%, #f8fffe 100%); border-radius: var(--border-radius-sm); border: 1px solid rgba(0, 0, 0, 0.05);">
                    {% if pepper.crop_path %}
                    <img src="/results/{{ pepper.crop_path }}?t={{ pepper.created_at.timestamp() }}" 
                         alt="{{ pepper.variety }}" 
                         onclick="showImagePreview(this.src, '{{ pepper.variety }}', '{{ pepper.quality_score|round|int }}%')"
                         style="width: 45px; height: 45px; border-radius: 8px; object-fit: cover; border: 2px solid #ffffff; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15); cursor: pointer; transition: transform 0.2s;"
                         onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                    {% else %}
                    <div style="width: 45px; height: 45px; border-radius: 8px; background: var(--primary-light); display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 1rem;">
                        <i class="fas fa-pepper-hot"></i>
                    </div>
                    {% endif %}
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 600; color: var(--dark); font-size: 0.85rem; margin-bottom: 0.25rem;">{{ pepper.variety }}</div>
                        <div style="font-size: 0.7rem; color: var(--secondary);">
                            <i class="fas fa-clock"></i> {{ pepper.created_at.strftime('%b %d, %I:%M %p') }}
                        </div>
                    </div>
                    <div style="padding: 0.4rem 0.8rem; border-radius: 12px; font-weight: 600; font-size: 0.75rem; 
                        {% if pepper.quality_score >= 80 %}background: rgba(16, 185, 129, 0.15); color: #10b981;
                        {% elif pepper.quality_score >= 60 %}background: rgba(59, 130, 246, 0.15); color: #3b82f6;
                        {% elif pepper.quality_score >= 40 %}background: rgba(245, 158, 11, 0.15); color: #f59e0b;
                        {% else %}background: rgba(239, 68, 68, 0.15); color: #ef4444;{% endif %}">
                        {{ pepper.quality_score|round|int }}%
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p style="text-align: center; color: var(--secondary); padding: 2rem;">No recent activity.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Image Preview Modal -->
<div id="imagePreviewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 10000; justify-content: center; align-items: center; padding: 2rem; backdrop-filter: blur(10px);" onclick="closeImagePreview()">
    <div style="position: relative; max-width: 90vw; max-height: 90vh; display: flex; flex-direction: column; align-items: center;">
        <!-- Close Button -->
        <button onclick="closeImagePreview()" style="position: absolute; top: -40px; right: 0; background: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #1e293b; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); transition: all 0.2s; z-index: 10001;"
                onmouseover="this.style.transform='scale(1.1)'; this.style.background='#ef4444'; this.style.color='white';" 
                onmouseout="this.style.transform='scale(1)'; this.style.background='white'; this.style.color='#1e293b';">
            <i class="fas fa-times"></i>
        </button>
        
        <!-- Image -->
        <img id="previewImage" src="" alt="Pepper Preview" 
             style="max-width: 100%; max-height: calc(90vh - 100px); border-radius: var(--border-radius); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); object-fit: contain;"
             onclick="event.stopPropagation()">
        
        <!-- Image Info -->
        <div style="background: white; padding: 1.5rem 2rem; border-radius: var(--border-radius); margin-top: 1rem; text-align: center; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);" onclick="event.stopPropagation()">
            <h3 id="previewTitle" style="font-size: 1.3rem; font-weight: 700; color: var(--dark); margin: 0 0 0.5rem 0;">
                <i class="fas fa-pepper-hot" style="color: var(--primary);"></i> 
                <span id="previewVariety"></span>
            </h3>
            <p style="color: var(--secondary); margin: 0; font-size: 0.9rem;">
                Quality Score: <strong id="previewQuality" style="color: var(--primary); font-size: 1.1rem;"></strong>
            </p>
        </div>
    </div>
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
    // Image Preview Functions
    function showImagePreview(imageSrc, variety, quality) {
        const modal = document.getElementById('imagePreviewModal');
        const previewImage = document.getElementById('previewImage');
        const previewVariety = document.getElementById('previewVariety');
        const previewQuality = document.getElementById('previewQuality');
        
        previewImage.src = imageSrc;
        previewVariety.textContent = variety;
        previewQuality.textContent = quality;
        
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden'; // Prevent scrolling when modal is open
    }
    
    function closeImagePreview() {
        const modal = document.getElementById('imagePreviewModal');
        modal.style.display = 'none';
        document.body.style.overflow = 'auto'; // Restore scrolling
    }
    
    // Close modal on Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeImagePreview();
        }
    });
    
    // Chart.js default configuration
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.color = '#64748b';
    
    // Quality Distribution Pie Chart
    const qualityCtx = document.getElementById('qualityChart').getContext('2d');
    new Chart(qualityCtx, {
        type: 'doughnut',
        data: {
            labels: ['Excellent (80-100)', 'Good (60-79)', 'Fair (40-59)', 'Poor (0-39)'],
            datasets: [{
                data: [
                    {{ quality_distribution.excellent }},
                    {{ quality_distribution.good }},
                    {{ quality_distribution.fair }},
                    {{ quality_distribution.poor }}
                ],
                backgroundColor: [
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(245, 158, 11, 0.8)',
                    'rgba(239, 68, 68, 0.8)'
                ],
                borderColor: [
                    'rgba(16, 185, 129, 1)',
                    'rgba(59, 130, 246, 1)',
                    'rgba(245, 158, 11, 1)',
                    'rgba(239, 68, 68, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: { size: 12 }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.parsed || 0;
                            let total = context.dataset.data.reduce((a, b) => a + b, 0);
                            let percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return label + ': ' + value + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });
    
    // Variety Distribution Bar Chart
    const varietyCtx = document.getElementById('varietyChart').getContext('2d');
    new Chart(varietyCtx, {
        type: 'bar',
        data: {
            labels: [{% for item in variety_data %}'{{ item.variety }}'{% if not loop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                label: 'Count',
                data: [{% for item in variety_data %}{{ item.count }}{% if not loop.last %}, {% endif %}{% endfor %}],
                backgroundColor: 'rgba(79, 70, 229, 0.7)',
                borderColor: 'rgba(79, 70, 229, 1)',
                borderWidth: 2,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        afterLabel: function(context) {
                            let index = context.dataIndex;
                            let avgQuality = [{% for item in variety_data %}{{ item.avg_quality }}{% if not loop.last %}, {% endif %}{% endfor %}][index];
                            return 'Avg Quality: ' + avgQuality + '%';
                        }
                    }
                }
            },
            scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1 } }
            }
        }
    });
    
    // Temporal Analysis Line Chart
    const temporalCtx = document.getElementById('temporalChart').getContext('2d');
    new Chart(temporalCtx, {
        type: 'line',
        data: {
            labels: [{% for item in temporal_data %}'{{ item.date }}'{% if not loop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                label: 'Peppers Analyzed',
                data: [{% for item in temporal_data %}{{ item.count }}{% if not loop.last %}, {% endif %}{% endfor %}],
                borderColor: 'rgba(79, 70, 229, 1)',
                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: 'rgba(79, 70, 229, 1)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: { mode: 'index', intersect: false }
            },
            scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1 } },
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45,
                        callback: function(value, index) {
                            return index % 5 === 0 ? this.getLabelForValue(value) : '';
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}

